<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unwrap USDT0 to gUSDT - Stable Testnet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Ethers UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: sans-serif; max-width: 480px; margin: 40px auto; padding: 0 16px; }
    button { padding: 10px; border-radius: 6px; border: none; cursor: pointer; }
    button.primary { background: #2563eb; color: white; width: 100%; margin-top: 12px; }
    input { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; }
    #status { background: #f5f5f5; padding: 10px; margin-top: 12px; border-radius: 6px; white-space: pre-line; font-size: 13px; }
    .label { font-size: 13px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Unwrap USDT0 ‚Üí gUSDT (Stable Testnet)</h2>

  <button id="connectBtn" class="primary">Connect Wallet</button>
  <div id="walletAddress"></div>

  <div class="label">Saldo USDT0: <span id="usdt0Balance">-</span></div>
  <div class="label">Saldo gUSDT (native): <span id="gasBalance">-</span></div>

  <input id="amount" type="text" placeholder="Jumlah USDT0 (contoh: 50)" />
  <button id="unwrapBtn" class="primary" disabled>Unwrap USDT0 ‚Üí gUSDT</button>

  <div id="status"></div>

  <script>
    const USDT0_ADDRESS   = "0x78Cf24370174180738C5B8E352B6D14c83a6c9A9";
    const WRAPPER_ADDRESS = "0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90";
    const USDT0_DECIMALS  = 6;

    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) external view returns (uint256)",
      "function balanceOf(address account) external view returns (uint256)"
    ];

    const WRAPPER_ABI = [
      "function withdrawTo(address recipient, uint256 amount) returns (uint256)"
    ];

    let provider, signer, userAddress;

    const statusEl      = document.getElementById("status");
    const connectBtn    = document.getElementById("connectBtn");
    const unwrapBtn     = document.getElementById("unwrapBtn");
    const walletEl      = document.getElementById("walletAddress");
    const amountInput   = document.getElementById("amount");
    const usdt0BalEl    = document.getElementById("usdt0Balance");
    const gasBalEl      = document.getElementById("gasBalance");

    function log(msg) {
      statusEl.textContent += msg + "\n";
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    async function refreshBalances() {
      try {
        const usdt0 = new window.ethers.Contract(USDT0_ADDRESS, ERC20_ABI, provider);
        const usdt0Bal = await usdt0.balanceOf(userAddress);
        usdt0BalEl.textContent = window.ethers.utils.formatUnits(usdt0Bal, USDT0_DECIMALS);

        const nativeBal = await provider.getBalance(userAddress);
        gasBalEl.textContent = window.ethers.utils.formatUnits(nativeBal, 18);
      } catch (e) {
        console.error(e);
      }
    }

    async function connectWallet() {
      if (!window.ethereum) {
        alert("Install MetaMask dulu mas ‚úÖ");
        return;
      }

      await window.ethereum.request({ method: "eth_requestAccounts" });

      provider = new window.ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      walletEl.textContent = "‚úÖ Connected: " + userAddress;
      unwrapBtn.disabled = false;

      const net = await provider.getNetwork();
      log("üì° Chain ID: " + net.chainId.toString());
      log("‚úÖ Wallet berhasil connect!");

      await refreshBalances();
    }

    async function unwrap() {
      const rawAmount = amountInput.value.trim();
      if (!rawAmount) {
        alert("Isi jumlah USDT0 dulu mas ‚úÖ");
        return;
      }

      unwrapBtn.disabled = true;
      log("üöÄ Mulai unwrap USDT0 ‚Üí gUSDT...");

      try {
        const usdt0   = new window.ethers.Contract(USDT0_ADDRESS, ERC20_ABI, signer);
        const wrapper = new window.ethers.Contract(WRAPPER_ADDRESS, WRAPPER_ABI, signer);

        const amount = window.ethers.utils.parseUnits(rawAmount, USDT0_DECIMALS);

        // üîπ Cek saldo USDT0
        const bal = await usdt0.balanceOf(userAddress);
        log("üí∞ Saldo USDT0: " + window.ethers.utils.formatUnits(bal, USDT0_DECIMALS));
        if (bal.lt(amount)) {
          log("‚ùå Saldo USDT0 kurang dari amount yang diminta.");
          unwrapBtn.disabled = false;
          return;
        }

        // üîπ Cek allowance
        const allowance = await usdt0.allowance(userAddress, WRAPPER_ADDRESS);
        log("üîé Allowance USDT0 ke wrapper: " + window.ethers.utils.formatUnits(allowance, USDT0_DECIMALS));

        if (allowance.lt(amount)) {
          log("‚úÖ Kirim approve (MaxUint256)...");
          const approveTx = await usdt0.approve(WRAPPER_ADDRESS, window.ethers.constants.MaxUint256);
          log("‚è≥ Approve tx: " + approveTx.hash);
          await approveTx.wait();
          log("‚úÖ Approve confirmed!");
        } else {
          log("‚úÖ Allowance cukup ‚Äî skip approve");
        }

        // üîπ Panggil withdrawTo ‚Üí UNWRAP USDT0 ‚Üí gUSDT
        log("üî• Call withdrawTo (UNWRAP USDT0 ‚Üí gUSDT)...");
        const tx = await wrapper.withdrawTo(userAddress, amount);
        log("‚è≥ withdrawTo tx: " + tx.hash);
        await tx.wait();
        log("üéâ SUCCESS! Harusnya gUSDT (native) nambah dan USDT0 berkurang ‚úÖ");

        await refreshBalances();

      } catch (err) {
        console.error(err);
        log("‚ùå ERROR:");
        log(err.message || err.toString());
      }

      unwrapBtn.disabled = false;
    }

    connectBtn.onclick = connectWallet;
    unwrapBtn.onclick  = unwrap;
  </script>
</body>
</html>
