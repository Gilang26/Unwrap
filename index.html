<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THDX Unwrap USDT0 ‚Üí gUSDT (v1.3.5 Stable Connect Fix)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b1220;
      color: #e6edf3;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .card {
      background: #121a2a;
      padding: 25px;
      border-radius: 14px;
      border: 1px solid #2a3b52;
      width: min(400px, 90vw);
      text-align: center;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.4);
    }
    h2 { color: #7c5cff; margin-top: 0; }
    input, button {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      font-size: 15px;
    }
    input {
      border: 1px solid #333;
      background: #0f1625;
      color: white;
    }
    button {
      border: 0;
      cursor: pointer;
      font-weight: 700;
      transition: 0.2s;
    }
    #connect { background: linear-gradient(90deg,#6ee7ff,#7c5cff); color: #000; }
    #mint { background: linear-gradient(90deg,#facc15,#f59e0b); color: #000; }
    #unwrap { background: linear-gradient(90deg,#22c55e,#16a34a); color: #fff; }
    pre {
      background: #0f1625;
      color: #8ab4f8;
      padding: 10px;
      border-radius: 8px;
      text-align: left;
      white-space: pre-wrap;
      margin-top: 15px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>üíß THDX Unwrap USDT0 ‚Üí gUSDT</h2>
    <button id="connect">üîå Connect Wallet</button>
    <p id="status">Menunggu koneksi wallet...</p>
    <p id="balance">Saldo: -</p>
    <input id="amount" type="number" placeholder="Jumlah (contoh: 100)" />
    <button id="unwrap" disabled>üöÄ Unwrap Sekarang</button>
    <pre id="log">log siap...</pre>
  </div>

  <script>
    const USDT0 = "0x78cf24370174180738c5b8e352b6d14c83a6c9a9";
    const WRAPPER = "0xcab8f3ed8528655e0c2fad1c504c6cf eccf50b90"; // hapus spasi sebelum disimpan
    const STABLE = {
      id: 2201,
      hex: "0x899",
      name: "Stable Testnet",
      rpc: "https://stable-jsonrpc.testnet.chain0.dev",
      explorer: "https://blockscout.testnet.stable.xyz"
    };

    let provider, signer, me;

    const log = (m) => {
      const el = document.getElementById("log");
      el.textContent += "\n" + m;
      el.scrollTop = el.scrollHeight;
      console.log(m);
    };

    async function ensureStableChain() {
      const net = await provider.getNetwork();
      if (net.chainId === STABLE.id) return true;
      log("‚öôÔ∏è Ganti jaringan ke Stable Testnet...");
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: STABLE.hex }]
        });
        return true;
      } catch (e) {
        if (e.code === 4902) {
          log("üîß Menambahkan jaringan Stable Testnet...");
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: STABLE.hex,
              chainName: STABLE.name,
              rpcUrls: [STABLE.rpc],
              blockExplorerUrls: [STABLE.explorer],
              nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 }
            }]
          });
          return true;
        } else {
          log("‚ùå Tidak bisa ganti network: " + e.message);
          return false;
        }
      }
    }

    async function connectWallet() {
      try {
        if (!window.ethereum) throw new Error("‚ùå MetaMask belum terdeteksi.");
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        me = await signer.getAddress();
        const net = await provider.getNetwork();
        log(`‚úÖ Connected: ${me}\nChain: ${net.chainId}`);
        document.getElementById("status").textContent = `Wallet: ${me}`;
        const ok = await ensureStableChain();
        if (!ok) return;
        document.getElementById("unwrap").disabled = false;
        await updateBalance();
      } catch (e) {
        log("‚ùå Connect error: " + e.message);
      }
    }

    async function updateBalance() {
      const erc20 = new ethers.Contract(USDT0, ["function balanceOf(address) view returns (uint256)"], provider);
      const bal = await erc20.balanceOf(me);
      const val = Number(ethers.utils.formatUnits(bal, 6));
      document.getElementById("balance").textContent = `Saldo: ${val} USDT0`;
    }

    async function unwrapNow() {
      try {
        const amount = document.getElementById("amount").value.trim();
        if (!amount) return alert("Isi jumlah dulu (mis. 10)");
        const amtLD = ethers.utils.parseUnits(amount, 6);

        const erc20 = new ethers.Contract(USDT0, [
          "function approve(address,uint256) returns (bool)",
          "function balanceOf(address) view returns (uint256)"
        ], signer);

        const balance = await erc20.balanceOf(me);
        if (balance.lt(amtLD)) return log("‚ùå Saldo USDT0 tidak cukup.");

        log(`üßæ Approving ${amount} USDT0 ke ${WRAPPER}...`);
        const txA = await erc20.approve(WRAPPER, amtLD);
        log(`‚è≥ TX Approve: ${txA.hash}`);
        await txA.wait();
        log("‚úÖ Approve sukses!");

        const wrapper = new ethers.Contract(WRAPPER, ["function depositTo(address,uint256) external"], signer);
        const txB = await wrapper.depositTo(me, amtLD);
        log(`üöÄ Unwrap TX: ${txB.hash}`);
        await txB.wait();
        log("‚úÖ USDT0 sukses diubah jadi gUSDT üéâ");
        await updateBalance();
      } catch (e) {
        log("‚ùå Error: " + (e.data?.message || e.message || e));
      }
    }

    document.getElementById("connect").onclick = connectWallet;
    document.getElementById("unwrap").onclick = unwrapNow;
  </script>
</body>
</html>
